<!DOCTYPE html>
<html>
<head>
    <title>Force Cleanup Example</title>
</head>
<body>
    <h1>BLE Force Cleanup Example</h1>
    <button id="cleanupBtn">Force Cleanup BLE Connections</button>
    <div id="status"></div>
    
    <script>
        const wsUrl = 'ws://localhost:8080';
        const statusDiv = document.getElementById('status');
        const cleanupBtn = document.getElementById('cleanupBtn');
        
        function log(message) {
            statusDiv.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
        }
        
        async function forceCleanupBLE() {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(wsUrl);
                const timeout = setTimeout(() => {
                    ws.close();
                    reject(new Error('Force cleanup timeout'));
                }, 5000);
                
                ws.onopen = () => {
                    log('Connected to bridge server');
                    log('Sending force_cleanup command...');
                    ws.send(JSON.stringify({ type: 'force_cleanup' }));
                };
                
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    log(`Received: ${JSON.stringify(msg)}`);
                    
                    if (msg.type === 'force_cleanup_complete') {
                        clearTimeout(timeout);
                        log('✅ Force cleanup completed successfully');
                        ws.close();
                        resolve(msg);
                    }
                };
                
                ws.onerror = (error) => {
                    clearTimeout(timeout);
                    log('❌ WebSocket error');
                    reject(error);
                };
                
                ws.onclose = () => {
                    log('Connection closed');
                };
            });
        }
        
        // Button click handler
        cleanupBtn.onclick = async () => {
            cleanupBtn.disabled = true;
            statusDiv.innerHTML = ''; // Clear previous logs
            
            try {
                await forceCleanupBLE();
                log('Ready for new BLE connections');
            } catch (error) {
                log(`❌ Error: ${error.message}`);
            } finally {
                cleanupBtn.disabled = false;
            }
        };
        
        // Example: Call cleanup on page load (useful for e2e tests)
        window.forceCleanupBLE = forceCleanupBLE;
        
        // Auto-cleanup on page load (optional)
        // window.addEventListener('load', async () => {
        //     try {
        //         await forceCleanupBLE();
        //         log('Initial cleanup completed');
        //     } catch (error) {
        //         log(`Initial cleanup failed: ${error.message}`);
        //     }
        // });
    </script>
</body>
</html>