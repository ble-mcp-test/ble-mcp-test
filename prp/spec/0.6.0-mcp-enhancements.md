# Specification: v0.6.0 MCP Enhancements

## Overview

Version 0.6.0 focuses on enhancing the MCP (Model Context Protocol) tools to improve developer experience, particularly around test isolation and connection stability.

## Background

During v0.5.6 testing, we identified several areas where enhanced MCP tooling would significantly improve the developer experience:

1. **Test Isolation Issues**: Hardware devices like CS108 accumulate state between tests, causing test failures
2. **Limited Visibility**: Current tools don't provide enough insight into session state
3. **Connection Stability**: MCP connections timeout after 1-2 minutes of inactivity

## Goals

1. Enable reliable test isolation for hardware device testing
2. Provide comprehensive session state visibility
3. Improve MCP connection stability
4. Maintain device-agnostic architecture (no CS108-specific logic)

## Proposed Features

### 1. Device Reset Tool

**Tool Name**: `mcp__ble-mcp-test__reset_device`

**Purpose**: Force a complete BLE disconnect/reconnect cycle to ensure clean device state between tests.

**Parameters**:
- `device_name` (optional): Specific device to reset, or current device if omitted
- `force` (optional, default: true): Force cleanup even if grace period active
- `verify_cleanup` (optional, default: true): Verify Noble resources are released

**Returns**:
```json
{
  "success": true,
  "device_name": "CS108-12345",
  "cleanup_performed": {
    "sessions_closed": 1,
    "resources_released": true,
    "device_available": true
  }
}
```

**Implementation Notes**:
- Leverages existing `SessionManager.forceCleanupDevice()`
- Includes Noble resource verification
- Optionally scans for device availability after cleanup

### 2. Ensure Clean State Tool

**Tool Name**: `mcp__ble-mcp-test__ensure_clean_state`

**Purpose**: Guarantee test isolation by ensuring system is in pristine state.

**Parameters**:
- `disconnect_all` (optional, default: true): Disconnect all active sessions
- `clear_buffers` (optional, default: true): Clear log buffers
- `wait_for_idle` (optional, default: true): Wait for system to be idle
- `timeout_ms` (optional, default: 5000): Maximum time to wait

**Returns**:
```json
{
  "success": true,
  "actions_taken": {
    "sessions_cleaned": 2,
    "buffers_cleared": true,
    "waited_ms": 1200
  },
  "final_state": {
    "active_sessions": 0,
    "connected_devices": 0,
    "system_idle": true
  }
}
```

**Use Case**:
```javascript
// In test beforeEach/afterEach
await mcp.ensure_clean_state({
  disconnect_all: true,
  wait_for_idle: true
});
```

### 3. Enhanced Connection State Tool

**Tool Name**: `mcp__ble-mcp-test__get_session_details`

**Purpose**: Provide comprehensive visibility into session state (enhancement of existing `get_connection_state`).

**Parameters**:
- `session_id` (optional): Specific session or all sessions

**Returns**:
```json
{
  "sessions": [{
    "session_id": "test-session-123",
    "status": {
      "connected": true,
      "device_name": "CS108-12345",
      "has_transport": true,
      "has_grace_period": false,
      "grace_remaining_ms": 0,
      "idle_time_sec": 45,
      "idle_timeout_sec": 300,
      "active_websockets": 1,
      "created_at": "2024-01-20T10:30:00Z",
      "last_activity": "2024-01-20T10:30:45Z"
    },
    "health": {
      "responsive": true,
      "packet_loss_rate": 0.0,
      "average_latency_ms": 12
    }
  }],
  "system": {
    "total_sessions": 1,
    "active_connections": 1,
    "noble_resources": {
      "listeners": 45,
      "peripheral_cache": 1
    }
  }
}
```

### 4. MCP Connection Stability

**Enhancement**: Add keep-alive mechanism to MCP HTTP transport

**Implementation**:
- Add periodic ping frames to MCP HTTP transport
- Configure HTTP server with longer keep-alive timeout
- Add connection state monitoring to MCP server

**Configuration**:
```env
BLE_MCP_HTTP_KEEPALIVE_MS=30000  # Send keepalive every 30s
BLE_MCP_HTTP_TIMEOUT_MS=300000   # 5 minute timeout
```

## Non-Goals

1. **Device-specific features**: No CS108-specific logic or protocol interpretation
2. **Data interpretation**: Continue to be a pure byte transport
3. **Complex orchestration**: Keep tools simple and focused

## Implementation Plan

1. **Phase 1**: Implement reset_device and ensure_clean_state tools
2. **Phase 2**: Enhance get_session_details with comprehensive state
3. **Phase 3**: Add MCP connection keep-alive
4. **Phase 4**: Testing and documentation

## Testing

1. **Unit tests**: Test each tool in isolation
2. **Integration tests**: Verify tools work together
3. **E2E tests**: Confirm test isolation works in real scenarios
4. **Stress tests**: Ensure tools work under load

## Migration Notes

- Existing `get_connection_state` remains for compatibility
- New tools are additive, no breaking changes
- All tools follow existing MCP conventions

## Success Metrics

1. Zero test failures due to device state contamination
2. MCP connections stable for 30+ minutes of idle time
3. Clear visibility into all session states
4. Maintained device-agnostic architecture